<%
  # Logica visuale inline per lo stato (veloce e chiara)
  is_active = Date.current.between?(subscription.start_date, subscription.end_date)
  is_future = Date.current < subscription.start_date
  is_expired = Date.current > subscription.end_date
%>

<tr>
  <td>
    <% if is_active %>
      <span class="badge badge-success gap-2 text-white font-bold">
        Attivo
      </span>
    <% elsif is_future %>
      <span class="badge badge-warning gap-2"> Futuro </span>
    <% else %>
      <span class="badge badge-ghost gap-2 opacity-50"> Scaduto </span>
    <% end %>
  </td>

  <td class="font-bold text-lg"><%= subscription.product.name %></td>

  <td>
    <div class="flex flex-col text-sm">
      <span class="font-mono <%= 'opacity-50' if is_expired %>">
        Dal: <%= format_date(subscription.start_date) %>
      </span>

      <span class="font-mono font-bold <%= is_expired ? 'opacity-50' : 'text-primary' %>">
        Al: &nbsp;<%= format_date(subscription.end_date) %>
      </span>
    </div>
  </td>

  <td class="text-center">
    <% if is_active %>
      <div class="stat-value text-xl text-success text-center">
        <%= display_value((subscription.end_date - Date.current).to_i) %>
      </div>
      <div class="text-[10px] uppercase tracking-wider opacity-60">
        Giorni rimasti
      </div>
    <% else %>
      <span class="opacity-30 text-xs font-mono">
        <%= display_value((subscription.end_date - subscription.start_date).to_i) %>
        gg tot
      </span>
    <% end %>
  </td>

  <td class="text-sm">
    <% if subscription.sale %>
      <div
        class="
          flex items-center gap-2 opacity-70 group-hover:opacity-100
          transition-opacity
        "
      >
        <%= icon("receipt", size: 16) %>

        <% if subscription.sale.receipt_code %>
          <span class="font-mono">
            <%= link_to [ subscription.sale ], class: "link link-hover" do %>
              <%= subscription.sale.receipt_code %>
            <% end %>
          </span>
        <% else %>
          <span>
            <%= format_datetime(subscription.sale.created_at, format: :long) %>
          </span>
        <% end %>
      </div>
    <% end %>
  </td>

  <td>
    <% if subscription.end_date >= 7.days.ago.to_date %>
      <%= link_to subscription_path(subscription),
		  class: "btn btn-ghost btn-xs text-error hover:bg-error/10 tooltip",
		  title: "Annulla Abbonamento e Vendita",
		  data: { 
		    turbo_method: :delete, 
		    turbo_confirm: "SEI SICURO?\n\nEliminando l'abbonamento verrÃ  annullata anche la VENDITA (incasso) di #{format_money(subscription.sale&.amount)}.\n\nContinuare?" 
		  } do %>
        <%= icon("delete", size: 16) %>
      <% end %>
    <% end %>
  </td>
</tr>
