<%= turbo_stream_from @member %>

<%= render layout: "members/shell", locals: { member: @member } do %>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <%# --- COLONNA SINISTRA: DATI & STATO --- %>
    <div class="space-y-6">
      <%# 1. CERTIFICATO MEDICO %>
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4">
          <h3
            class="
              text-xs font-bold uppercase opacity-50 tracking-wider mb-3
              flex items-center gap-2
            "
          >
            <%= icon("med", size: 14) %> Certificato Medico
          </h3>

          <% if @member.medical_certificate_valid? %>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 text-success font-bold">
                <%= icon("success", size: 20) %>
                <span>Valido</span>
              </div>

              <div class="text-right">
                <div class="text-xs opacity-60">Scade il</div>

                <div class="font-mono text-sm">
                  <%= format_date(@member.medical_certificate_expiry) %>
                </div>
              </div>
            </div>
          <% else %>
            <div class="flex items-center gap-3 text-error mb-2">
              <%= icon("warning", size: 24) %>

              <div class="leading-tight">
                <div class="font-bold">Scaduto o Mancante</div>
                <div class="text-xs opacity-70">Accesso limitato.</div>
              </div>
            </div>
            <% if @member.medical_certificate_expiry %>
              <div class="text-xs text-center opacity-60 mb-3">
                Scaduto il:
                <%= format_date(@member.medical_certificate_expiry) %>
              </div>
            <% end %>
          <% end %>

          <div class="divider my-1"></div>

          <%= link_to edit_member_path(@member),
		      class: "btn btn-xs btn-outline w-full",
		      data: { turbo_frame: "modal" } do %>
            Aggiorna Data
          <% end %>
        </div>
      </div>

      <%# 2. CONTATTI %>
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4 text-sm">
          <h3
            class="
              text-xs font-bold uppercase opacity-50 tracking-wider mb-3
              flex items-center gap-2
            "
          >
            <%= icon("badge", size: 14) %> Anagrafica
          </h3>

          <div class="space-y-3">
            <div class="flex gap-3">
              <div class="w-6 opacity-50"><%= icon("phone", size: 16) %></div>

              <div class="font-mono">
                <%= @member.phone.present? ? @member.phone : "-" %>
              </div>
            </div>

            <div class="flex gap-3">
              <div class="w-6 opacity-50"><%= icon("mail", size: 16) %></div>

              <div class="truncate" title="<%= @member.email_address %>">
                <%= format_email(@member.email_address) %>
              </div>
            </div>

            <div class="flex gap-3">
              <div class="w-6 opacity-50"><%= icon("home", size: 16) %></div>

              <div class="leading-tight">
                <%= display_value(@member.full_address) %>
              </div>
            </div>

            <div class="flex gap-3">
              <div class="w-6 opacity-50"><%= icon("cake", size: 16) %></div>

              <div>
                <%= format_date(@member.birth_date) %>

                <span class="text-xs opacity-50 ml-1">
                  (<%= time_ago_in_words(@member.birth_date) %>)
                </span>
              </div>
            </div>

            <div class="flex gap-3">
              <div class="w-6 opacity-50">
                <%= icon("fingerprint", size: 16) %>
              </div>

              <div class="font-mono"><%= @member.fiscal_code %></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# --- COLONNA DESTRA: OPERATIVITÃ€ (2/3 width) --- %>
    <div class="lg:col-span-2 space-y-6">
      <%# 3. LISTA ABBONAMENTI (Attivi & Futuri) %>
      <div class="card bg-base-100 shadow-md border border-base-200">
        <div class="card-body p-0">
          <%# Header Card %>
          <div
            class="
              p-4 border-b border-base-200 bg-base-200/30 rounded-t-box flex
              justify-between items-center
            "
          >
            <h3
              class="
                font-bold text-sm uppercase opacity-70 tracking-wider flex
                items-center gap-2
              "
            >
              <%= icon("credit_card", size: 18) %> Abbonamenti
            </h3>

            <%= link_to "Vedi Tutti", member_subscriptions_path(@member), class: "link link-hover text-xs opacity-60" %>
          </div>

          <div class="p-4 grid gap-3">
            <%
              # LOGICA RUBY DI FILTRO (usa il tuo Concern SoftDeletable)
              # 1. Filtriamo via i discarded usando il metodo .kept? del concern
              # 2. Teniamo solo quelli che non sono ancora finiti (Active + Future)

              valid_subs = @member.subscriptions.select do |s| 
                s.kept? && s.end_date >= Date.current 
              end

              # Ordiniamo: Prima quelli che iniziano prima
              sorted_subs = valid_subs.sort_by(&:start_date)
            %>

            <% if sorted_subs.any? %>
              <% sorted_subs.each do |sub| %>
                <% today = Date.current
                   is_future = sub.start_date > today
                   days_left = (sub.end_date - today).to_i
                   is_expiring_soon = !is_future && days_left.between?(0, 7)
                   
                   # Classi dinamiche basate sullo stato
                   border_class = if is_future
                     "border-info/30 bg-info/5"
                   elsif is_expiring_soon
                     "border-warning/50 bg-warning/5"
                   else
                     "border-base-300 bg-base-100 hover:border-primary/30"
                   end %>

                <div class="relative flex flex-col sm:flex-row sm:items-center justify-between p-4 border rounded-xl transition-all <%= border_class %> gap-4">
                  <%# Badge "Futuro" o "Scadenza" %>
                  <% if is_future %>
                    <span
                      class="
                        absolute top-0 right-0 rounded-bl-lg rounded-tr-lg
                        bg-info text-info-content text-[10px] font-bold px-2
                        py-0.5 uppercase tracking-wider
                      "
                    >
                      Futuro
                    </span>
                  <% elsif is_expiring_soon %>
                    <span
                      class="
                        absolute top-0 right-0 rounded-bl-lg rounded-tr-lg
                        bg-warning text-warning-content text-[10px]
                        font-bold px-2 py-0.5 uppercase tracking-wider
                      "
                    >
                      Scade Presto
                    </span>
                  <% end %>

                  <%# Icona e Dettagli %>
                  <div class="flex items-start gap-3">
                    <div class="p-2.5 rounded-lg <%= is_future ? 'bg-info/10 text-info' : 'bg-primary/10 text-primary' %>">
                      <%= icon(is_future ? "clock" : "success", size: 24) %>
                    </div>

                    <div>
                      <h4 class="font-bold text-lg leading-none mb-1">
                        <%= sub.product&.name %>
                      </h4>

                      <div class="text-sm opacity-70 flex flex-col gap-0.5">
                        <% if is_future %>
                          <span class="text-info font-medium">
                            Inizia il <%= l(sub.start_date) %>
                          </span>
                          <span class="text-xs">
                            fino al <%= l(sub.end_date) %>
                          </span>
                        <% else %>
                          <span>
                            Scade il <strong><%= l(sub.end_date) %></strong>
                          </span>
                          <span class="text-xs opacity-60">
                            Iniziato il <%= l(sub.start_date) %>
                          </span>
                        <% end %>
                      </div>
                    </div>
                  </div>

                  <%# Azione (Rinnova solo se attivo) %>
                  <div class="flex items-center gap-4 self-end sm:self-center mt-2 sm:mt-0">
                    <% unless is_future %>
                      <div class="text-right hidden sm:block">
                        <div
                          class="
                            text-2xl font-black font-mono leading-none
                            tracking-tight opacity-20
                          "
                        >
                          <%= days_left %>
                        </div>

                        <div class="text-[9px] uppercase font-bold opacity-40">
                          giorni
                        </div>
                      </div>
                      <%= link_to new_sale_path(member_id: @member.id, renew_subscription_id: sub.id),
                          class: "btn btn-sm #{is_expiring_soon ? 'btn-primary' : 'btn-ghost border-base-300'}",
                          data: { turbo_frame: "modal" } do %>
                        <%= icon("reset", size: 16) %>
                        <span class="hidden lg:inline">Rinnova</span>
                      <% end %>
                    <% else %>
                      <%# Tasto Modifica per Futuri %>
                      <%# = link_to edit_subscription_path(sub), class: "btn btn-square btn-ghost btn-sm opacity-50 hover:opacity-100", title: "Modifica date" do %>
                      <%# = icon("edit", size: 16) %>
                      <%# end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <%# Empty State %>
              <div class="text-center py-6">
                <div
                  class="
                    bg-base-200 w-12 h-12 rounded-full flex items-center
                    justify-center mx-auto mb-2 opacity-50
                  "
                >
                  <%= icon("shopping_cart", size: 20) %>
                </div>

                <h4 class="font-bold opacity-70 text-sm">
                  Nessun servizio attivo
                </h4>

                <div class="mt-3">
                  <%= link_to new_sale_path(member_id: @member.id),
                      class: "btn btn-primary btn-sm btn-outline",
                      data: { turbo_frame: "modal" } do %>
                    Vendi Abbonamento
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <%# 4. ACQUISTI RECENTI %>
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-0">
          <div
            class="
              p-4 border-b border-base-200 bg-base-200/30 flex
              justify-between items-center
            "
          >
            <h3
              class="
                font-bold text-sm uppercase opacity-70 tracking-wider flex
                items-center gap-2
              "
            >
              <%= icon("receipt", size: 16) %> Storico Acquisti
            </h3>

            <%= link_to "Vedi Tutti", member_sales_path(@member), class: "link link-hover text-xs opacity-60" %>
          </div>

          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th class="pl-4">Data</th>
                  <th>Prodotto</th>
                  <th class="text-right pr-4">Importo</th>
                </tr>
              </thead>

              <tbody>
                <%# Qui mostriamo semplicemente le ultime 5 vendite %>
                <% @member.sales.order(created_at: :desc).limit(5).each do |sale| %>
                  <tr
                    class="hover:bg-base-200/50 cursor-pointer group"
                    onclick="window.location='<%= sale_path(sale) %>'"
                  >
                    <td class="pl-4 font-mono text-xs text-base-content/70">
                      <%= l(sale.sold_on) %>
                    </td>

                    <td>
                      <div class="font-medium group-hover:text-primary transition-colors">
                        <%= sale.product_name_snapshot %>
                      </div>

                      <div class="text-[10px] opacity-50 font-mono">
                        <%= sale.receipt_code %>
                      </div>
                    </td>

                    <td class="text-right pr-4 font-bold font-mono">
                      <%= number_to_currency(sale.try(:amount) || (sale.amount_cents / 100.0)) %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>

            <% if @member.sales.empty? %>
              <div class="p-4 text-center text-sm opacity-40 italic">
                Nessun movimento registrato.
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
