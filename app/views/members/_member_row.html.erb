<% cache [member, member.subscriptions.maximum(:updated_at), Date.current] do %>
  <tr id="<%= dom_id(member) %>_row">
    <%# 1. AVATAR & ANAGRAFICA (Rimane uguale) %>
    <td class="py-3 pl-4 align-top w-[35%]">
      <div class="flex items-start gap-3">
        <div class="avatar avatar-placeholder indicator">
          <% status_color = case member.status_label
               when "success" then "status-success"
               when "warning" then "status-warning"
               else "status-error"
             end %>

          <span class="indicator-item status <%= status_color %>"></span>

          <div
            class="rounded-full w-10"
            style="<%= member.avatar_color_style %>"
          >
            <span class="font-bold font-mono"><%= member.initials %></span>
          </div>
        </div>

        <div class="flex flex-col min-w-0">
          <%= link_to member_path(member),
		      class: "font-bold text-base-content hover:text-primary transition-colors truncate" do %>
            <%= highlight member.full_name, params.dig(:query, :query) %>
          <% end %>

          <div class="flex flex-wrap items-center gap-2 mt-0.5">
            <span class="font-mono opacity-50 text-sm">
              <%= format_date(member.birth_date) %>
            </span>

            <% if member.birth_date > 18.years.ago %>
              <span class="badge badge-xs badge-ghost px-1 py-0 h-4 leading-none">
                Minore
              </span>
            <% end %>
          </div>
        </div>
      </div>
    </td>

    <%# 2. ABBONAMENTI FLOW LATERALE %>
    <td class="align-middle w-[45%]">
      <%#
        QUI IL CAMBIAMENTO: 
        1. Usiamo il metodo del model `relevant_subscriptions`
        2. CSS: flex-wrap per andare a capo, flex-row (default) per stare affiancati
      %>

      <div class="flex flex-wrap gap-2 items-center content-start">
        <% subs = member.relevant_subscriptions %>

        <% if subs.any? %>
          <% subs.each do |sub| %>
            <% days_left = (sub.end_date - Date.current).to_i 
               is_expired = days_left < 0
               is_expiring_soon = days_left.between?(0, 7)
               
               wrapper_class, icon_name = if is_expired
                  ["bg-error/10 border-error/30 text-error-content hover:bg-error/20", "warning"]
               elsif is_expiring_soon
                  ["bg-warning/10 border-warning/30 text-warning-content hover:bg-warning/20", "clock"]
               else
                  ["bg-base-100 border-base-300 text-base-content/70 hover:border-base-400", "success"]
               end
               
               # Mostra il tasto rinnovo se scaduto o scade tra poco
               show_renew = is_expired || is_expiring_soon %>

            <%# CARD COMPATTA %>
            <div class="flex items-center border rounded-md overflow-hidden shadow-sm <%= wrapper_class %> transition-all h-8 max-w-[200px]">
              <%# Icona e Nome %>
              <div
                class="
                  px-2 flex items-center gap-1.5 text-xs h-full select-none
                  cursor-default
                "
                title="Scadenza: <%= format_date(sub.end_date) %>"
              >
                <%= icon(icon_name, size: 12, class: (is_expired ? "text-error" : (is_expiring_soon ? "text-warning" : "text-success"))) %>

                <span class="font-bold truncate max-w-[100px]">
                  <%= sub.product.name %>
                </span>

                <%# Giorni Rimanenti (solo testo piccolino) %>
                <span class="opacity-60 text-[9px] tabular-nums tracking-tighter">
                  <%= is_expired ? "-#{days_left.abs}gg" : "#{days_left}gg" %>
                </span>
              </div>

              <%# Action: Rinnova %>
              <% if show_renew %>
                <div class="border-l border-current/10 h-full">
                  <%= link_to new_sale_path(member_id: member.id, renew_subscription_id: sub.id),
                      class: "px-2 h-full flex items-center justify-center hover:bg-white/20 transition-colors text-current",
                      title: "Rinnova ora",
                      data: { turbo_frame: "modal" } do %>
                    <%= icon("reset", size: 12) %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <%# Stato Vuoto %>
          <span class="text-xs opacity-30 italic pl-1 flex items-center gap-1">
            <span class="w-1.5 h-1.5 rounded-full bg-base-300"></span>
            Inattivo
          </span>
        <% end %>
      </div>
    </td>

    <%# 3. CERTIFICATO (Compatto) %>
    <td class="align-middle w-[15%]">
      <% expiry = member.medical_certificate_expiry %>

      <% if expiry %>
        <% if member.medical_certificate_valid? %>
          <div
            class="tooltip tooltip-left"
            data-tip="Scade il <%= format_date(expiry) %>"
          >
            <div
              class="
                flex items-center gap-1 text-xs font-medium text-success
                opacity-80
              "
            >
              <%= icon("success", size: 14) %>
              <span><%= expiry.year %></span>
            </div>
          </div>
        <% else %>
          <div
            class="tooltip tooltip-left"
            data-tip="Scaduto il <%= l(expiry) %>"
          >
            <div
              class="
                flex items-center gap-1 text-xs font-bold text-error
                animate-pulse
              "
            >
              <%= icon("warning", size: 14) %>
              <span>SCAD</span>
            </div>
          </div>
        <% end %>
      <% else %>
        <span class="text-[10px] opacity-30 uppercase font-bold tracking-wider">
          Manca
        </span>
      <% end %>
    </td>

    <%# 4. AZIONI %>
    <td class="text-right w-1 pr-4 align-middle">
      <div class="join">
        <%= link_to [member],
		    class: "join-item btn btn-square btn-xs btn-ghost tooltip tooltip-left",
		    data: { tip: "Dettaglio" } do %>
          <%= icon("view", size: 16) %>
        <% end %>

        <%= link_to [:edit, member],
		    class: "join-item btn btn-square btn-xs btn-ghost tooltip tooltip-left",
		    data: { tip: "Modifica", turbo_frame: "modal" } do %>
          <%= icon("edit", size: 16) %>
        <% end %>

        <% if current_user.admin? %>
          <%= link_to [member],
		    class: "join-item text-error btn btn-square btn-xs btn-ghost tooltip tooltip-left",
		    data: {
		      tip: "Archivia",
		      turbo_method: :delete,
		      turbo_confirm: "Sei sicuro di voler archiviare #{member.full_name}?"
		    } do %>
            <%= icon("delete", size: 16) %>
          <% end %>
        <% end %>
      </div>
    </td>
  </tr>
<% end %>
