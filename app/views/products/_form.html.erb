<%= form_with(model: product, class: "space-y-6") do |f| %>
  <%= render "shared/form_errors", model: product %>

  <%# --- SEZIONE 1: DETTAGLI PRODOTTO --- %>
  <fieldset class="fieldset bg-base-100 border border-base-300 p-4 rounded-box shadow-sm">
    <legend class="fieldset-legend">
      <%= icon("shopping_tag", size: 14) %> Dettagli Prodotto
    </legend>

    <%# Nome Prodotto %>
    <div>
      <%= f.label :name, class: "label" %>

      <%= f.text_field :name, 
          required: true, 
          class: "input w-full text-lg font-medium", 
          placeholder: "Es. Mensile Open, Carnet 10 Ingressi..." %>
    </div>

    <%# Griglia: Prezzo, Durata, Categoria %>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full mt-2">
      <%# Prezzo %>
      <div>
        <%= f.label :price, class: "label" %>

        <label class="input w-full font-mono">
          <span class="opacity-50">€</span>

          <%= f.text_field :price, 
              class: "grow border-none focus:ring-0 p-0", 
              placeholder: "0,00", 
              inputmode: "decimal" %>
        </label>
      </div>

      <%# Durata %>
      <div>
        <%= f.label :duration_days, "Durata (Giorni)", class: "label" %>

        <%= f.number_field :duration_days, 
            class: "input w-full", 
            placeholder: "30" %>

        <p class="label opacity-50">
          30 = 1 Mese, 365 = 1 Anno
        </p>
      </div>

      <%# Categoria %>
      <div>
        <%= f.label :accounting_category, class: "label" %>

        <%= f.select :accounting_category, 
            Product.accounting_categories.keys.map { |k| [k.titleize, k] }, 
            {}, 
            class: "select w-full" %>
      </div>
    </div>
  </fieldset>

  <%# --- SEZIONE 2: ACCESSI E DISCIPLINE --- %>
  <fieldset class="fieldset bg-base-100 border border-base-300 p-4 rounded-box shadow-sm">
    <legend class="fieldset-legend">
      <%= icon("fitness_center", size: 14) %> Discipline Incluse
    </legend>

    <p class="text-sm text-base-content/70 mb-4 px-1">
      Seleziona a quali discipline e tornelli darà accesso questo abbonamento.
    </p>

    <% if Discipline.kept.any? %>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <%= f.collection_check_boxes :discipline_ids, Discipline.kept.order(:name), :id, :name do |b| %>
          <label
            class="
              cursor-pointer label border border-base-200 rounded-lg
              hover:bg-base-200/50 hover:border-base-300 transition-all p-3
              justify-start gap-3 group
            "
          >
            <%= b.check_box class: "checkbox checkbox-primary checkbox-sm" %>

            <span
              class="
                label-text font-medium group-hover:text-primary
                transition-colors
              "
            >
              <%= b.text %>
            </span>
          </label>
        <% end %>
      </div>
    <% else %>
      <div class="alert alert-warning text-sm shadow-sm">
        <%= icon("warning", size: 18) %>

        <div>
          <h3 class="font-bold">Nessuna disciplina trovata</h3>

          <div class="text-xs">
            Devi creare almeno una disciplina prima di associarla.
            <%= link_to "Creane una ora", new_discipline_path, class: "underline" %>.
          </div>
        </div>
      </div>
    <% end %>
  </fieldset>

  <%# --- AZIONI --- %>
  <div class="modal-action mt-8 flex items-center justify-end gap-2">
    <%= link_to "Annulla", products_path, class: "btn btn-ghost" %>

    <%= button_tag type: "submit", 
    class: "btn btn-primary", 
      data: { turbo_submits_with: '<span class="loading loading-dots loading-sm"></span> Salvataggio...' } do %>
      <%= icon("save", size: 18) %> Salva Prodotto
    <% end %>
  </div>
<% end %>
