<div class="container mx-auto max-w-7xl p-6 space-y-8">
  <%# --- HEADER: BENVENUTO E RICERCA --- %>
  <div
    class="
      flex flex-col md:flex-row gap-6 justify-between items-end
      md:items-center
    "
  >
    <div>
      <h1 class="text-3xl font-bold tracking-tight flex items-center gap-2">
        Buongiorno, <%= Current.session.user.first_name %>
        <span class="animate-pulse">ðŸ‘‹</span>
      </h1>

      <p class="text-base-content/60 mt-1">
        Ecco l'andamento economico di oggi.
      </p>
    </div>

    <%# SEARCH BAR "SMART" %>
    <div class="w-full md:w-1/3">
      <%= form_with scope: :query, 
                    url: members_path, 
                    method: :get, 
                    class: "join w-full shadow-sm",
                    data: { turbo: false } do |f| %>
        <div class="relative w-full">
          <div
            class="
              absolute inset-y-0 left-0 flex items-center pl-3
              pointer-events-none opacity-50
            "
          >
            <%= icon("search", size: 20) %>
          </div>

          <%= f.text_field :query, 
          class: "input input-bordered w-full pl-10 join-item focus:outline-offset-0", 
            placeholder: "Cerca socio (Nome, CF, Email)...",
           autofocus: true %>
        </div>

        <%= button_tag type: "submit", class: "btn btn-primary join-item" do %>
          Cerca
        <% end %>
      <% end %>
    </div>
  </div>

  <%# --- SEZIONE 1: CASSA GIORNALIERA --- %>
  <div
    class="
      stats stats-vertical lg:stats-horizontal shadow-xl bg-base-100 w-full
      border border-base-200
    "
  >
    <%# MATTINA %>
    <div class="stat">
      <div class="stat-figure text-primary/20">
        <%= icon("sunny", size: 32) %>
      </div>

      <div class="stat-title font-bold opacity-60">Mattina (Cash)</div>

      <div class="stat-value text-3xl">
        <%= format_money(@daily_cash.morning_total) %>
      </div>

      <div class="stat-desc">Fino alle 14:00</div>
    </div>

    <%# POMERIGGIO %>
    <div class="stat">
      <div class="stat-figure text-secondary/20">
        <%= icon("moon", size: 32) %>
      </div>

      <div class="stat-title font-bold opacity-60">Pomeriggio (Cash)</div>

      <div class="stat-value text-3xl">
        <%= format_money(@daily_cash.afternoon_total) %>
      </div>

      <div class="stat-desc">Dopo le 14:00</div>
    </div>

    <%# TOTALE %>
    <div class="stat bg-primary text-primary-content">
      <div class="stat-figure text-primary-content/30">
        <%= icon("savings", size: 40) %>
      </div>

      <div
        class="
          stat-title text-primary-content/70 font-bold uppercase
          tracking-wider
        "
      >
        Totale Contanti
      </div>

      <div class="stat-value"><%= format_money(@daily_cash.total) %></div>
      <div class="stat-desc text-primary-content/60">Incasso odierno</div>
    </div>
  </div>

  <%# --- SEZIONE 2: GRIGLIA OPERATIVA --- %>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <%# --- COLONNA SINISTRA (2/3): ULTIME VENDITE (Nuova) --- %>
    <div class="lg:col-span-2 space-y-6">
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-0">
          <div
            class="
              p-4 border-b border-base-200 flex justify-between items-center
              bg-base-200/30
            "
          >
            <h3 class="font-bold text-lg flex items-center gap-2">
              <%= icon("receipt", size: 20) %> Ultime Transazioni
            </h3>

            <%= link_to "Vedi tutte", sales_path, class: "btn btn-xs btn-ghost" %>
          </div>

          <% if @recent_sales.any? %>
            <div class="overflow-x-auto">
              <table class="table table-zebra w-full">
                <thead>
                  <tr>
                    <th>Socio</th>
                    <th>Prodotto</th>
                    <th>Pagamento</th>
                    <th class="text-right">Importo</th>
                    <th></th>
                  </tr>
                </thead>

                <tbody>
                  <% @recent_sales.each do |sale| %>
                    <tr class="hover">
                      <td>
                        <div class="flex items-center gap-3">
                          <div class="font-bold">
                            <%= link_to sale.member.full_name, sale.member, class: "hover:underline" %>
                          </div>
                        </div>

                        <div class="text-xs opacity-50">
                          Reg. da <%= sale.user.first_name %>
                        </div>
                      </td>

                      <td>
                        <div class="badge badge-outline text-xs">
                          <%= sale.product.name %>
                        </div>
                      </td>

                      <td>
                        <span class="uppercase text-xs font-mono opacity-70">
                          <%= sale.payment_method %>
                        </span>
                      </td>

                      <td class="text-right font-bold text-primary">
                        <%= format_money(sale.amount) %>
                      </td>

                      <td class="text-right">
                        <%= link_to icon("view", size: 18), sale_path(sale), class: "btn btn-ghost btn-xs btn-square" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="p-10 text-center flex flex-col items-center gap-2 opacity-50">
              <%= icon("sell", size: 32) %>
              <span>Nessuna vendita registrata recentemente.</span>
              <%= link_to "Registra la prima", new_sale_path, class: "btn btn-sm btn-primary mt-2" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# --- COLONNA DESTRA (1/3): AZIONI & ALERT (Invariata) --- %>
    <div class="space-y-6">
      <%# CARD AZIONI RAPIDE %>
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body">
          <h3 class="card-title text-sm uppercase opacity-50 tracking-wider mb-2">
            Azioni Rapide
          </h3>

          <div class="flex flex-col gap-3">
            <%= link_to new_sale_path, class: "btn btn-primary w-full shadow-md gap-2", data: { turbo_frame: "modal" } do %>
              <%= icon("sale", size: 20) %> Nuova Vendita
            <% end %>

            <%= link_to new_member_path, class: "btn btn-outline w-full gap-2", data: { turbo_frame: "modal" } do %>
              <%= icon("person_add", size: 20) %> Nuovo Iscritto
            <% end %>
          </div>
        </div>
      </div>

      <%# CARD SCADENZE %>
      <% if @expiring_count > 0 %>
        <div class="alert alert-warning shadow-md items-start">
          <%= icon("notification_important", size: 24, class: "mt-1") %>

          <div>
            <h3 class="font-bold">Scadenze in arrivo!</h3>

            <div class="text-xs">
              Ci sono <strong class="text-lg"><%= @expiring_count %></strong>
              abbonamenti in scadenza nei prossimi 7 giorni.
            </div>
          </div>
        </div>
      <% else %>
        <div class="card bg-base-100 shadow-sm border border-base-200">
          <div class="card-body p-4 text-center">
            <div class="text-success flex justify-center mb-2">
              <%= icon("check_circle", size: 32) %>
            </div>

            <div class="font-bold text-sm">Nessuna scadenza imminente</div>

            <div class="text-xs opacity-60">
              Tutto tranquillo per i prossimi 7 giorni.
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
