<%# Data Controller: Colleghiamo il form al controller Stimulus 'sales-form' %>

<%= form_with(model: sale, 
      class: "grid grid-cols-1 xl:grid-cols-3 gap-6 items-start",
      data: { controller: "sales-form" }) do |f| %>
  <%# --- COLONNA SINISTRA (2/3) --- %>
  <div class="xl:col-span-2 space-y-6">
    <%= render "shared/form_errors", model: sale %>

    <%# --- SEZIONE 1: CHI E COSA --- %>
    <fieldset class="fieldset bg-base-100 border border-base-300 p-4 rounded-box shadow-sm">
      <legend class="fieldset-legend">
        <%= icon("person_add", size: 14) %> Chi e Cosa
      </legend>

      <%# 1. SELEZIONE SOCIO %>
      <div class="w-full mb-4">
        <% if sale.member %>
          <%# CASO A: Socio già deciso (es. arrivi dal profilo) %>
          <%# Mettiamo il target sull'hidden field così il JS può leggere l'ID se serve %>
          <%= f.hidden_field :member_id, data: { sales_form_target: "memberSelect" } %>
          <div
            class="
              flex items-center justify-between p-3 bg-base-200/50 border
              border-base-200 rounded-lg
            "
          >
            <div class="flex items-center gap-3">
              <div class="avatar avatar-placeholder">
                <div
                  class="rounded-full w-10"
                  style="<%= sale.member.avatar_color_style %>"
                >
                  <span class="font-bold font-mono">
                    <%= sale.member.initials %>
                  </span>
                </div>
              </div>

              <div>
                <div class="font-bold text-lg leading-none">
                  <%= sale.member.full_name %>
                </div>

                <div class="text-xs font-mono opacity-60 mt-1">
                  <%= sale.member.fiscal_code %>
                </div>
              </div>
            </div>

            <%= link_to "Cambia", members_path(q: "selection"), class: "btn btn-sm btn-ghost text-error" %>
          </div>
        <% else %>
          <%# CASO B: Selezione Socio manuale %>
          <%= f.label :member_id, "Socio Acquirente", class: "label" %>
          <%= f.collection_select :member_id, 
              Member.kept.order(:last_name), :id, :full_name, 
              { prompt: "Seleziona Socio..." }, 
              { 
                class: "select select-bordered w-full", 
                required: true,
                data: { 
                  sales_form_target: "memberSelect",
                  action: "change->sales-form#refreshData"
                } 
              } %>
        <% end %>
      </div>

      <div class="divider my-2 opacity-50"></div>

      <%# 2. SELEZIONE PRODOTTO (RAGGRUPPATO PER DISCIPLINA) %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="w-full">
          <%= f.label :product_id, "Prodotto / Servizio", class: "label" %>

          <% products = Product.kept.includes(:disciplines).order(:name)
          grouped_hash = products.group_by { |p| p.disciplines.first&.name || "Generale" }
          sorted_groups = grouped_hash.sort_by { |name, _| name }
          grouped_options = sorted_groups.map do |discipline_name, group_products|
            [
              discipline_name,
              group_products.map { |p| 
                [
                  p.name, 
                  p.id, 
                  {
		    'data-price': p.price.to_s,
		    'data-duration': p.duration_days.to_s,
		  }
                ] 
              }
            ]
          end %>

          <%= f.select :product_id, 
              grouped_options_for_select(grouped_options, sale.product_id),
              { prompt: "Seleziona Prodotto..." },
              { 
                class: "select select-bordered w-full font-medium",
                required: true,
                data: { 
                  sales_form_target: "productSelect",
                  action: "change->sales-form#refreshData"
                }
              } %>
        </div>

        <%# 3. DATA INIZIO VALIDITÀ (Annidata) %>
        <div class="w-full">
          <%= f.fields_for :subscription do |sub_form| %>
            <%= sub_form.label :start_date, class: "label" do %>
              <span>Inizio Validità</span>
              <span class="label-text-alt opacity-50">Auto-calcolata</span>
            <% end %>

            <%# Qui il JS scriverà la data suggerita %>
            <%= sub_form.date_field :start_date, 
            class: "input w-full",
	       data: {
		 sales_form_target: "startDateInput", 
		 action: "input->sales-form#recalculateEndDate"
	       } %>
          <% end %>
        </div>
      </div>
    </fieldset>

    <%# --- SEZIONE 2: ECONOMIA & PAGAMENTO --- %>
    <fieldset class="fieldset bg-base-100 border border-base-300 p-4 rounded-box shadow-sm">
      <legend class="fieldset-legend">
        <%= icon("payments", size: 14) %> Transazione
      </legend>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <%# IMPORTO %>
        <div>
          <%= f.label :amount, "Importo Finale (€)", class: "label" %>

          <label
            class="
              input w-full flex items-center gap-2 font-mono text-lg
              font-bold text-primary
            "
          >
            €
            <%= f.text_field :amount, 
                required: true,
                class: "grow border-none focus:ring-0 p-0", 
                placeholder: "0,00",
                inputmode: "decimal",
                data: {
                  sales_form_target: "amountInput",
                  action: "input->sales-form#updateTotalDisplay"
                } %>
          </label>
        </div>

        <%# DATA INCASSO %>
        <div>
          <%= f.label :sold_on, "Data Incasso", class: "label" %>
          <%= f.date_field :sold_on, required: true, class: "input w-full" %>
        </div>
      </div>

      <%# METODO DI PAGAMENTO %>
      <div class="w-full mb-4">
        <%= f.label :payment_method, "Metodo di Pagamento", class: "label" %>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <% Sale.payment_methods.keys.each_with_index do |method, index| %>
            <label class="cursor-pointer group relative">
              <%= f.radio_button :payment_method, method, 
                  class: "peer sr-only", 
                  checked: (index == 0 && f.object.payment_method.nil?) || f.object.payment_method == method %>

              <div
                class="
                  p-3 rounded-lg border border-base-300 bg-base-100
                  text-center transition-all hover:bg-base-200
                  peer-checked:border-primary peer-checked:bg-primary/10
                  peer-checked:text-primary peer-checked:font-bold
                "
              >
                <span class="text-xs uppercase"><%= method.humanize %></span>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <%# NOTE %>
      <div
        class="
          collapse collapse-arrow border border-base-200 bg-base-100
          rounded-box
        "
      >
        <input type="checkbox" />

        <div class="collapse-title text-sm font-medium opacity-70 py-3 min-h-0">
          Aggiungi Note (Opzionale)
        </div>

        <div class="collapse-content">
          <%= f.text_area :notes, class: "textarea textarea-bordered w-full h-20" %>
        </div>
      </div>
    </fieldset>
  </div>

  <%# --- COLONNA DESTRA: RIEPILOGO VISIVO --- %>
  <div class="xl:col-span-1 sticky top-6">
    <div class="card bg-base-100 shadow-xl border border-primary/20">
      <div class="card-body p-6">
        <h3 class="font-bold text-lg text-base-content flex items-center gap-2 mb-4">
          <%= icon("receipt", size: 20) %> Riepilogo
        </h3>

        <%# TOTALE VISIVO %>
        <div
          class="
            bg-base-200/50 rounded-xl p-4 text-center mb-4 border
            border-base-200
          "
        >
          <div class="text-xs uppercase font-bold opacity-50 tracking-wider">
            Totale da Incassare
          </div>

          <div class="text-4xl font-black font-mono text-primary mt-1">
            <span data-sales-form-target="totalDisplay">0,00</span>
            <span class="text-xl align-top opacity-50">€</span>
          </div>
        </div>

        <%# --- NUOVO BLOCCO DATE --- %>
        <div class="bg-base-100 rounded-lg border border-base-200 p-3 mb-6 text-sm">
          <div class="flex justify-between items-center mb-2">
            <span class="opacity-60 text-xs font-bold uppercase">Inizio</span>

            <span
              class="font-mono font-bold"
              data-sales-form-target="startDateDisplay"
            >
              ---
            </span>
          </div>

          <div class="flex justify-between items-center">
            <span class="opacity-60 text-xs font-bold uppercase">Scadenza</span>

            <span
              class="font-mono font-bold text-primary"
              data-sales-form-target="endDateDisplay"
            >
              ---
            </span>
          </div>

          <div class="divider my-1 opacity-10"></div>

          <div
            class="text-center text-xs opacity-50 italic"
            data-sales-form-target="statusDisplay"
          >
            Seleziona un prodotto...
          </div>
        </div>

        <%# ------------------------ %>

        <div class="flex flex-col gap-3">
          <%= button_tag type: "submit", class: "btn btn-primary w-full shadow-lg h-12 text-lg" do %>
            <%= icon("print", size: 22) %> Emetti Ricevuta
          <% end %>

          <%= link_to "Annulla", :back, class: "btn btn-ghost btn-sm w-full text-base-content/60" %>
        </div>
      </div>
    </div>
  </div>
<% end %>
