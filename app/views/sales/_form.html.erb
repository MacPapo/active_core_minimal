<%= form_with(model: sale, class: "grid grid-cols-1 xl:grid-cols-3 gap-6 items-start") do |f| %>
  <%# --- COLONNA SINISTRA: DATI VENDITA (2/3) --- %>
  <div class="xl:col-span-2 space-y-6">
    <%= render "shared/form_errors", model: sale %>

    <%# --- SEZIONE 1: CHI E COSA --- %>
    <fieldset class="fieldset bg-base-100 border border-base-300 p-4 rounded-box shadow-sm">
      <legend class="fieldset-legend">
        <%= icon("person_add", size: 14) %> Chi e Cosa
      </legend>

      <%# 1. SELEZIONE SOCIO %>
      <div class="w-full mb-4">
        <% if sale.member %>
          <%# CASO 1: Socio già selezionato %>
          <%= f.hidden_field :member_id %>
          <div
            class="
              flex items-center justify-between p-3 bg-base-200/50 border
              border-base-200 rounded-lg
            "
          >
            <div class="flex items-center gap-3">
              <div class="avatar placeholder">
                <div class="bg-primary text-primary-content rounded-full w-10">
                  <span class="text-lg font-bold"><%= sale.member %></span>
                </div>
              </div>

              <div>
                <div class="font-bold text-lg leading-none">
                  <%= sale.member.full_name %>
                </div>

                <div class="text-xs font-mono opacity-60 mt-1">
                  <%= sale.member.fiscal_code %>
                </div>
              </div>
            </div>

            <%= link_to "Cambia", members_path(q: "selection"), class: "btn btn-sm btn-ghost text-error" %>
          </div>
        <% else %>
          <%# CASO 2: Nuovo inserimento %>
          <%= f.label :member_id, "Socio Acquirente", class: "label" %>
          <%# FIX VALIDAZIONE: Aggiunto required: true %>
          <%= f.collection_select :member_id, 
              Member.kept.order(:last_name), :id, :full_name, 
              { prompt: "Seleziona Socio..." }, 
              { class: "select select-bordered w-full", required: true } %>
        <% end %>
      </div>

      <div class="divider my-2 opacity-50"></div>

      <%# 2. SELEZIONE PRODOTTO %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="w-full">
          <%= f.label :product_id, "Prodotto / Servizio", class: "label" %>

          <%# FIX VALIDAZIONE: Aggiunto required: true %>
          <%= f.collection_select :product_id, 
              Product.kept.order(:name), :id, :name, 
              { prompt: "Seleziona Prodotto..." }, 
              { class: "select select-bordered w-full font-medium", required: true } %>
        </div>

        <%# 3. DATA INIZIO VALIDITÀ (Annidata) %>
        <div class="w-full">
          <%# Usiamo fields_for per accedere all'oggetto associato %>
          <%= f.fields_for :subscription do |sub_form| %>
            <%= sub_form.label :start_date, class: "label" do %>
              <span>Inizio Validità</span>
              <span class="label-text-alt opacity-50">Opzionale</span>
            <% end %>

            <%# Rails genererà name="sale[subscription_attributes][start_date]" %>
            <%= sub_form.date_field :start_date, 
            class: "input w-full",
               title: "Se diverso da oggi (es. rinnovo futuro)" %>
          <% end %>
        </div>
      </div>
    </fieldset>

    <%# --- SEZIONE 2: ECONOMIA & PAGAMENTO --- %>
    <fieldset class="fieldset bg-base-100 border border-base-300 p-4 rounded-box shadow-sm">
      <legend class="fieldset-legend">
        <%= icon("payments", size: 14) %> Transazione
      </legend>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <%# IMPORTO %>
        <div>
          <%= f.label :amount, "Importo Finale (€)", class: "label" %>

          <label
            class="
              input w-full flex items-center gap-2 font-mono text-lg
              font-bold text-primary
            "
          >
            € <%# FIX VALIDAZIONE: required, min, step %>
            <%= f.text_field :amount, 
                required: true,
                pattern: "[0-9]+([,\.][0-9]+)?", 
                title: "Inserisci un importo valido (es. 10,50)",
                class: "grow border-none focus:ring-0 p-0", 
                placeholder: "0,00",
                inputmode: "decimal" %>
          </label>
        </div>

        <%# DATA TRANSAZIONE %>
        <div>
          <%= f.label :sold_on, "Data Incasso", class: "label" %>

          <%# FIX VALIDAZIONE: required %>
          <%= f.date_field :sold_on, required: true, class: "input w-full" %>
        </div>
      </div>

      <%# METODO DI PAGAMENTO %>
      <div class="w-full mb-4">
        <%= f.label :payment_method, "Metodo di Pagamento", class: "label" %>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <% Sale.payment_methods.keys.each_with_index do |method, index| %>
            <label class="cursor-pointer group relative">
              <%# FIX VALIDAZIONE: Selezioniamo il primo di default per evitare form inviati senza metodo %>
              <%= f.radio_button :payment_method, method, class: "peer sr-only", checked: (index == 0 && f.object.payment_method.nil?) || f.object.payment_method == method %>

              <div
                class="
                  p-3 rounded-lg border border-base-300 bg-base-100 text-center transition-all
                  hover:border-primary/50 hover:bg-base-200
                  peer-checked:border-primary peer-checked:bg-primary/10 peer-checked:text-primary peer-checked:font-bold
                "
              >
                <% icon_name = case method 
                   when 'cash' then 'payments'
                   when 'credit_card' then 'credit_card'
                   when 'bank_transfer' then 'account_balance'
                   else 'other' end %>

                <%= icon(icon_name, size: 24, class: "mx-auto mb-1 opacity-70 group-hover:opacity-100 peer-checked:opacity-100") %>
                <span class="text-xs uppercase"><%= method.humanize %></span>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <%# NOTE %>
      <div
        class="
          collapse collapse-arrow border border-base-200 bg-base-100
          rounded-box
        "
      >
        <input type="checkbox" />

        <div class="collapse-title text-sm font-medium opacity-70 py-3 min-h-0">
          Aggiungi Note (Opzionale)
        </div>

        <div class="collapse-content">
          <%= f.text_area :notes, class: "textarea textarea-bordered w-full h-20", placeholder: "Es. Pagamento parziale, sconto famiglia..." %>
        </div>
      </div>
    </fieldset>
  </div>

  <div class="xl:col-span-1 sticky top-6">
    <div class="card bg-base-100 shadow-xl border border-primary/20">
      <div class="card-body p-6">
        <h3 class="font-bold text-lg text-base-content flex items-center gap-2 mb-4">
          <%= icon("receipt", size: 20) %> Riepilogo
        </h3>

        <%# TOTALE VISIVO %>
        <div
          class="
            bg-base-200/50 rounded-xl p-4 text-center mb-6 border
            border-base-200
          "
        >
          <div class="text-xs uppercase font-bold opacity-50 tracking-wider">
            Totale da Incassare
          </div>

          <div class="text-4xl font-black font-mono text-primary mt-1">
            <span id="total-display">---</span>
            <span class="text-xl align-top opacity-50">€</span>
          </div>
        </div>

        <%# AZIONI %>
        <div class="flex flex-col gap-3">
          <%= button_tag type: "submit", class: "btn btn-primary w-full shadow-lg h-12 text-lg" do %>
            <%= icon("print", size: 22) %> Emetti Ricevuta
          <% end %>

          <%= link_to "Annulla", :back, class: "btn btn-ghost btn-sm w-full text-base-content/60" %>
        </div>

        <div class="divider my-4 text-xs opacity-40">Info</div>

        <div class="text-xs text-base-content/60 space-y-2">
          <p>
            <%= icon("info", size: 12, class: "inline align-text-bottom") %>
            Premendo "Emetti" verrà generata la ricevuta e aggiornata la
            validità dell'abbonamento.
          </p>
        </div>
      </div>
    </div>
  </div>
<% end %>
